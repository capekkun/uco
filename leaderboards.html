<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donation Leaderboards - Semulight</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  
  <style>
     @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,300;0,400;1,600&display=swap');
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: Verdana, Geneva, Tahoma, sans-serif;
    background-color: white;
    text-align: center;
    width: 100%;
    margin: 0 auto;
    background-image: url(Web\ \(43\).svg);
  }

nav {
  width: 100%;
  background: url('Web\ \(21\).svg');
  background-size: cover;
  background-position: center;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 15px 5%;
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1000;
  transition: top 0.3s ease;
}

  .nav-logo {
    display: flex;
    align-items: center;
  }

  .logo {
    width: 100px;
    height: auto;
    margin-right: 20px;
  }

  nav ul {
    list-style: none;
    display: flex;
    gap: 1.5em;
    align-items: center;
  }

  nav ul li {
    position: relative;
  }

  nav ul li a {
    color: black;
    text-decoration: none;
    font-weight: bold;
    font-family: 'Poppins', sans-serif;
    padding: 8px 12px;
    display: block;
    transition: all 0.3s ease;
    font-size: 0.9em;
  }

nav ul li > a:hover {
  background: linear-gradient(45deg, #8a2be2, #9400d3);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* hamburger button */
    .hamburger {
      display: none;
      flex-direction: column;
      cursor: pointer;
    }

    .hamburger div {
      width: 25px;
      height: 3px;
      background: black;
      margin: 4px;
      transition: 0.3s;
    }

    /* responsive */
    @media (max-width: 768px) {
      .nav-links {
        display: none;
        position: absolute;
        top: 60px;
        right: 20px;
        background: white;
        flex-direction: column;
        padding: 10px;
        border: 1px solid #ddd;
      }

      .nav-links.active {
        display: flex;
      }

      .hamburger {
        display: flex;
      }
    }

    #userRole {
  background: rgba(0, 174, 140, 0.2);  /* Soft green background */
  color: #9B4DCA;  /* Text color matching the background */
  padding: 8px 16px;  /* Increased padding for better appearance */
  border-radius: 20px;  /* Rounded corners for a softer look */
  font-size: 1em;  /* Slightly larger text */
  font-weight: bold;  /* Bold text for emphasis */
  text-align: center;  /* Centered text */
  display: inline-block;  /* Makes it behave like a block element */
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);  /* Subtle shadow for depth */
  transition: all 0.3s ease;  /* Smooth transition for hover effect */
}

    .leaderboards-container {
      width: 95%;
      max-width: 1200px;
      margin: 20px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      color: #333;
      padding-top: 120px;  /* Add this line to push the form down */
    }

    .leaderboards-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .leaderboards-header h1 {
      color: #00AE8C;
      font-size: 2.8em;
      margin-bottom: 10px;
    }

    .leaderboards-header p {
      color: #666;
      font-size: 1.2em;
      max-width: 800px;
      margin: 0 auto;
    }

    .filter-section {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .filter-group label {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .filter-group select, .filter-group input {
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      min-width: 180px;
    }

    .timeframe-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .timeframe-btn {
      padding: 8px 15px;
      background-color: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .timeframe-btn.active {
      background-color: #00AE8C;
      color: white;
    }

    .timeframe-btn:hover:not(.active) {
      background-color: #dee2e6;
    }

    .leaderboard-content {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 30px;
      margin-top: 20px;
    }

    @media (max-width: 900px) {
      .leaderboard-content {
        grid-template-columns: 1fr;
      }
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
      
    }

    .leaderboard-table th, .leaderboard-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }

    .leaderboard-table th {
      background-color: #00AE8C;
      color: white;
      font-weight: 600;
    }

    .leaderboard-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .leaderboard-table tr:hover {
      background-color: #e9f7f3;
    }

    .rank-cell {
      font-weight: bold;
      text-align: center;
      width: 60px;
    }

    .top-1 .rank-cell {
      background-color: #FFD700;
      color: #333;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .top-2 .rank-cell {
      background-color: #C0C0C0;
      color: #333;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .top-3 .rank-cell {
      background-color: #CD7F32;
      color: #333;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }

    .user-cell {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #00AE8C;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .user-name {
      font-weight: 600;
    }

    .quantity-cell, .value-cell, .points-cell {
      font-weight: 600;
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      margin-left: 5px;
    }

    .badge-gold {
      background-color: #FFD700;
      color: #333;
    }

    .badge-silver {
      background-color: #C0C0C0;
      color: #333;
    }

    .badge-bronze {
      background-color: #CD7F32;
      color: white;
    }

    .badge-green {
      background-color: #00AE8C;
      color: white;
    }

    .badge-blue {
      background-color: #007bff;
      color: white;
    }

    .badge-purple {
      background-color: #9C27B0;
      color: white;
    }

    .sidebar {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar-section {
      margin-bottom: 25px;
    }

    .sidebar-section h3 {
      color: #00AE8C;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .stats-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
    }

    .stats-card h4 {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stats-card p {
      font-size: 1.5em;
      font-weight: bold;
      color: #00AE8C;
    }

    .progress-bar {
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: #00AE8C;
      border-radius: 4px;
    }

    .achievement-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .achievement-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #00AE8C;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .achievement-details h4 {
      margin-bottom: 5px;
      font-size: 0.9em;
    }

    .achievement-details p {
      font-size: 0.8em;
      color: #666;
    }

    .motivation-section {
      background: linear-gradient(135deg, #00AE8C, #009975);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
      text-align: center;
    }

    .motivation-section h3 {
      margin-bottom: 10px;
    }

    .btn {
      padding: 12px 25px;
      background-color: #00AE8C;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 10px 5px;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background-color: #008c6f;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 174, 140, 0.3);
    }

    .btn-large {
      padding: 15px 30px;
      font-size: 1.2em;
    }

    .view-toggle {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .view-btn {
      padding: 10px 20px;
      background-color: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 5px;
    }

    .view-btn.active {
      background-color: #00AE8C;
      color: white;
    }

    .view-btn:hover:not(.active) {
      background-color: #dee2e6;
    }

    .contact-info {
      font-size: 0.8em;
      color: #666;
    }

    .admin-only {
      background-color: #f8f9fa;
      border-left: 3px solid #00AE8C;
      padding: 8px;
      font-size: 0.8em;
      color: #666;
    }

    .points-info {
      background-color: #e7f3ff;
      border-left: 3px solid #007bff;
      padding: 10px;
      margin: 15px 0;
      border-radius: 4px;
    }

    .points-info h4 {
      color: #007bff;
      margin-bottom: 5px;
    }

    .points-info ul {
      text-align: left;
      margin-left: 20px;
      font-size: 0.9em;
    }

    @media (max-width: 768px) {
      .filter-section {
        flex-direction: column;
        align-items: center;
      }
      
      .filter-group {
        width: 100%;
        max-width: 300px;
      }
      
      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: #00AE8C;
        padding: 20px;
      }
      
      .nav-links.active {
        display: flex;
      }
      
      .hamburger {
        display: flex;
      }
      
      .view-toggle {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="menu.html" class="logo-link">
        <img src="Web (44).svg" alt="Logo" class="logo" />
    </a>

    <ul class="nav-links">
        <li><a href="Letsdonate.html">LET'S DONATE</a></li>
        <li><a href="leaderboards.html">LEADERBOARDS</a></li>
        <li><a href="chart.html">CHARTS</a></li>
        <!-- <li><a href="menu.html">SUSTAINABILITY</a></li> -->
        <li><a href="forum.html">FORUM</a></li>
        <li><a href="ContactUs.html">CONTACT US</a></li>
        <li><a href="AboutUs.html">ABOUT US</a></li>
        <li><a href="quiz chemistry.html">QUIZ</a></li>
        <li><a href="user.html">USER</a></li>
        <li><a href="signup.html" id="signUpBtn">SIGN UP</a></li>
        <li><a href="login.html" id="logInBtn">LOG IN</a></li>
        <li><a href="javascript:void(0)" id="logOutBtn" style="display: none;">LOG OUT</a></li>
        <li id="userRole" style="display: none; font-family: 'Poppins', sans-serif;"></li>
    </ul>

    <div class="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
  </nav>

  <div class="leaderboards-container">
    <div class="leaderboards-header">
      <h1>Donation Leaderboards</h1>
      <p>Compete with others and see who's making the biggest impact by recycling used cooking oil!</p>
    </div>

    <div class="filter-section">
      <div class="filter-group">
        <label for="state-filter">Filter by State:</label>
        <select id="state-filter">
          <option value="all">All States</option>
          <option value="Johor">Johor</option>
          <option value="Kedah">Kedah</option>
          <option value="Kelantan">Kelantan</option>
          <option value="Melaka">Melaka</option>
          <option value="Negeri Sembilan">Negeri Sembilan</option>
          <option value="Pahang">Pahang</option>
          <option value="Perak">Perak</option>
          <option value="Perlis">Perlis</option>
          <option value="Pulau Pinang">Pulau Pinang</option>
          <option value="Sabah">Sabah</option>
          <option value="Sarawak">Sarawak</option>
          <option value="Selangor">Selangor</option>
          <option value="Terengganu">Terengganu</option>
          <option value="Wilayah Persekutuan Kuala Lumpur">Wilayah Persekutuan Kuala Lumpur</option>
          <option value="Wilayah Persekutuan Labuan">Wilayah Persekutuan Labuan</option>
          <option value="Wilayah Persekutuan Putrajaya">Wilayah Persekutuan Putrajaya</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="event-filter">Filter by Event:</label>
        <select id="event-filter">
          <option value="all">All Events</option>
          <!-- Events will be populated dynamically -->
        </select>
      </div>

      <div class="filter-group">
        <label>Timeframe:</label>
        <div class="timeframe-buttons">
          <button class="timeframe-btn active" data-timeframe="all">All Time</button>
          <button class="timeframe-btn" data-timeframe="month">This Month</button>
          <button class="timeframe-btn" data-timeframe="week">This Week</button>
        </div>
      </div>
    </div>

    <div class="view-toggle">
      <button class="view-btn active" data-view="quantity">Rank by Quantity (kg)</button>
      <button class="view-btn" data-view="value">Rank by Value (RM)</button>
      <button class="view-btn" data-view="points">Rank by Points</button>
    </div>

    <div class="leaderboard-content">
      <div class="main-content">
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="rank-cell">Rank</th>
              <th>Donor</th>
              <th>Quantity (kg)</th>
              <th>Total Value (RM)</th>
              <th>Points</th>
              <th>Events Participated</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- Leaderboard data will be populated here -->
          </tbody>
        </table>
      </div>

      <div class="sidebar">
        <div class="sidebar-section">
          <h3>How to Rank</h3>
          <div class="stats-card">
            <h4>Individual Rankings</h4>
            <p>Each person is ranked separately based on their total donations</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 100%"></div>
            </div>
            <p style="font-size: 0.9em; color: #666;">No grouping - pure individual competition!</p>
          </div>

          <div class="points-info">
            <h4>Points System</h4>
            <ul>
              <li><strong>Total Points:</strong> Based on user profile points (from signup, quiz, donations, etc.)</li>
              <li><strong>Event Participation:</strong> 1 point per unique event</li>
              <li><strong>Consistent Donor:</strong> 10 points for 5+ different events</li>
              <li><strong>Donation Quantity:</strong> Already included in user profile points</li>
            </ul>
            <p><em>Total Points = User Profile Points + Event Participation Points</em></p>
          </div>

          <div class="stats-card">
            <h4>Current Top Donor</h4>
            <p id="top-donor-name">-</p>
            <p id="top-donor-amount">-</p>
          </div>
          
          <div class="admin-only" id="admin-info" style="display: none;">
            <i class="fas fa-lock"></i> Admin View: Contact information visible
          </div>
        </div>

        <div class="sidebar-section">
          <h3>Achievements</h3>
          <div class="achievement-item">
            <div class="achievement-icon">
              <i class="fas fa-seedling"></i>
            </div>
            <div class="achievement-details">
              <h4>First Donation</h4>
              <p>Donate for the first time</p>
            </div>
          </div>
          <div class="achievement-item">
            <div class="achievement-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <div class="achievement-details">
              <h4>Eco Warrior</h4>
              <p>Donate over 50kg total</p>
            </div>
          </div>
          <div class="achievement-item">
            <div class="achievement-icon">
              <i class="fas fa-medal"></i>
            </div>
            <div class="achievement-details">
              <h4>Community Hero</h4>
              <p>Participate in 5+ events</p>
            </div>
          </div>
          <div class="achievement-item">
            <div class="achievement-icon">
              <i class="fas fa-star"></i>
            </div>
            <div class="achievement-details">
              <h4>Points Master</h4>
              <p>Reach 1000 points</p>
            </div>
          </div>
        </div>

        <div class="motivation-section">
          <h3>Make a Difference Today!</h3>
          <p>Your donations help protect our environment and create sustainable energy.</p>
          <a href="Letsdonate.html" class="btn btn-large">Donate Now</a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut 
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      getDocs,
      query,
      where,
      orderBy,
      getDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBdDwCslP5RGHi37xjFo89x8rY3kKbhUwQ",
      authDomain: "semulight-db.firebaseapp.com",
      projectId: "semulight-db",
      storageBucket: "semulight-db.firebasestorage.app",
      messagingSenderId: "693934626490",
      appId: "1:693934626490:web:87c36c26026509f86f1483",
      measurementId: "G-QFFLDWLW2L"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const signUpBtn = document.getElementById('signUpBtn');
    const logInBtn = document.getElementById('logInBtn');
    const logOutBtn = document.getElementById('logOutBtn');
    const userRole = document.getElementById('userRole');
    const hamburger = document.querySelector(".hamburger");
    const navLinks = document.querySelector(".nav-links");
    const leaderboardBody = document.getElementById('leaderboard-body');
    const stateFilter = document.getElementById('state-filter');
    const eventFilter = document.getElementById('event-filter');
    const timeframeButtons = document.querySelectorAll('.timeframe-btn');
    const viewButtons = document.querySelectorAll('.view-btn');
    const topDonorName = document.getElementById('top-donor-name');
    const topDonorAmount = document.getElementById('top-donor-amount');
    const adminInfo = document.getElementById('admin-info');

    // Current user data
    let currentUser = null;
    let currentUserRole = null;
    let allDonations = [];
    let allEvents = [];
    let allUsers = {};
    let currentTimeframe = 'all';
    let currentView = 'quantity';

    // Navigation scroll behavior
    let lastScrollTop = 0;
    const nav = document.querySelector('nav');

    window.addEventListener('scroll', function () {
      let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll > lastScrollTop && currentScroll > 100) {
        nav.style.top = '-100px';
      } else {
        nav.style.top = '0';
      }
      lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    });

    // Hamburger menu functionality
    hamburger.addEventListener("click", () => {
      navLinks.classList.toggle("active");
    });

    // Check if user is logged in and get role
    onAuthStateChanged(auth, async function (user) {
      if (user) {
        currentUser = user;

        // User is signed in
        signUpBtn.style.display = 'none';
        logInBtn.style.display = 'none';
        logOutBtn.style.display = 'inline-block';
        userRole.style.display = 'inline-block';

        // Get user role from Firestore
        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            currentUserRole = userData.role || 'user';
            userRole.textContent = currentUserRole === 'admin' ? 'Admin' : 'User';
            
            // Show admin info if user is admin
            if (currentUserRole === 'admin') {
              adminInfo.style.display = 'block';
            }
          } else {
            currentUserRole = 'user';
            userRole.textContent = 'User';
          }
        } catch (error) {
          console.error("Error getting user document:", error);
          currentUserRole = 'user';
          userRole.textContent = 'User';
        }
      } else {
        // User is signed out
        currentUser = null;
        currentUserRole = null;

        signUpBtn.style.display = 'inline-block';
        logInBtn.style.display = 'inline-block';
        logOutBtn.style.display = 'none';
        userRole.style.display = 'none';
        adminInfo.style.display = 'none';
      }
      
      // Load data regardless of login status
      await loadLeaderboardData();
    });

    // Log out functionality
    logOutBtn.addEventListener('click', function () {
      signOut(auth).then(() => {
        currentUser = null;
        currentUserRole = null;
        window.location.href = "menu.html";
      }).catch((error) => {
        console.error("Error signing out:", error);
      });
    });

    // Timeframe buttons
    timeframeButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        timeframeButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentTimeframe = this.getAttribute('data-timeframe');
        updateLeaderboard();
      });
    });

    // View buttons
    viewButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        viewButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentView = this.getAttribute('data-view');
        updateLeaderboard();
      });
    });

    // Filter change events
    stateFilter.addEventListener('change', updateLeaderboard);
    eventFilter.addEventListener('change', updateLeaderboard);

    // Load leaderboard data
    async function loadLeaderboardData() {
      try {
        // Load all users data first
        await loadAllUsers();
        
        // Load events for filter
        await loadEvents();
        
        // Load donations
        const donationsQuery = query(collection(db, "donations"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(donationsQuery);
        allDonations = [];
        
        querySnapshot.forEach((doc) => {
          const donationData = doc.data();
          donationData.id = doc.id;
          
          // Find event name for this donation
          const event = allEvents.find(e => e.id === donationData.eventId);
          donationData.eventName = event ? event.name : 'Unknown Event';
          
          allDonations.push(donationData);
        });
        
        console.log(`Loaded ${allDonations.length} donations for leaderboard`);
        updateLeaderboard();
        
      } catch (error) {
        console.error("Error loading leaderboard data:", error);
        leaderboardBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">Error loading leaderboard data. Please try again later.</td></tr>`;
      }
    }

    // Load all users data
    async function loadAllUsers() {
      try {
        const usersQuery = query(collection(db, "users"));
        const querySnapshot = await getDocs(usersQuery);
        allUsers = {};
        
        querySnapshot.forEach((doc) => {
          allUsers[doc.id] = doc.data();
        });
        
        console.log(`Loaded ${Object.keys(allUsers).length} users for leaderboard`);
      } catch (error) {
        console.error("Error loading users data:", error);
      }
    }

    // Load events for filter
    async function loadEvents() {
      try {
        const eventsQuery = query(collection(db, "events"));
        const querySnapshot = await getDocs(eventsQuery);
        allEvents = [];
        
        // Keep "All Events" option
        eventFilter.innerHTML = '<option value="all">All Events</option>';
        
        querySnapshot.forEach((doc) => {
          const eventData = doc.data();
          eventData.id = doc.id;
          allEvents.push(eventData);
          
          // Add to filter dropdown
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = eventData.name;
          eventFilter.appendChild(option);
        });
        
      } catch (error) {
        console.error("Error loading events:", error);
      }
    }

    // Calculate points from user profile
    function getUserProfilePoints(userId) {
      if (allUsers[userId] && allUsers[userId].points) {
        return allUsers[userId].points;
      }
      return 0;
    }

    // Calculate points based on event participation from donations
    function calculateEventParticipationPoints(uniqueEventsCount) {
      let points = 0;
      
      // 1 point for each unique event participation
      points += uniqueEventsCount;
      
      // Bonus: 10 points for 5 or more different events
      if (uniqueEventsCount >= 5) {
        points += 10;
      }
      
      return points;
    }

    // Update leaderboard based on filters - FIXED: Don't double-count donation points
    async function updateLeaderboard() {
      // Apply filters
      const selectedState = stateFilter.value;
      const selectedEvent = eventFilter.value;
      
      let filteredDonations = [...allDonations];
      
      // Filter by state
      if (selectedState !== 'all') {
        filteredDonations = filteredDonations.filter(d => d.state === selectedState);
      }
      
      // Filter by event
      if (selectedEvent !== 'all') {
        filteredDonations = filteredDonations.filter(d => d.eventId === selectedEvent);
      }
      
      // Filter by timeframe
      if (currentTimeframe !== 'all') {
        const now = new Date();
        let startDate;
        
        if (currentTimeframe === 'month') {
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        } else if (currentTimeframe === 'week') {
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        }
        
        filteredDonations = filteredDonations.filter(d => {
          if (!d.timestamp) return false;
          const donationDate = d.timestamp.toDate ? d.timestamp.toDate() : new Date(d.timestamp);
          return donationDate >= startDate;
        });
      }
      
      console.log(`Filtered to ${filteredDonations.length} donations`);
      
      // Group donations by individual person (name + phone combination)
      const userStats = {};
      
      filteredDonations.forEach(donation => {
        // Create a unique key for each individual person
        const userKey = `${donation.name || 'Anonymous'}_${donation.phone || 'NoPhone'}`;
        
        if (!userStats[userKey]) {
          userStats[userKey] = {
            name: donation.name || 'Anonymous Donor',
            phone: donation.phone || 'N/A',
            totalQuantity: 0,
            totalValue: 0,
            userProfilePoints: 0,
            eventParticipationPoints: 0,
            totalPoints: 0,
            events: new Set(), // Track unique event IDs
            donations: 0,
            userId: donation.userId || null
          };
          
          // Add user profile points if we have user ID
          if (donation.userId && allUsers[donation.userId]) {
            userStats[userKey].userProfilePoints = allUsers[donation.userId].points || 0;
          }
        }
        
        // Add this donation to the person's totals
        userStats[userKey].totalQuantity += parseFloat(donation.quantity) || 0;
        userStats[userKey].totalValue += parseTotalValue(donation.total) || 0;
        
        // Add event ID to track unique event participation
        if (donation.eventId) {
          userStats[userKey].events.add(donation.eventId);
        }
        
        userStats[userKey].donations += 1;
      });
      
      // Calculate points for each user - FIXED: Don't double-count donation points
      Object.keys(userStats).forEach(userKey => {
        const user = userStats[userKey];
        const uniqueEventsCount = user.events.size;
        
        // Calculate points from event participation only
        user.eventParticipationPoints = calculateEventParticipationPoints(uniqueEventsCount);
        
        // Total points = user profile points (which already include donation points) + event participation points
        user.totalPoints = user.userProfilePoints + user.eventParticipationPoints;
      });
      
      // Convert to array and sort
      const userArray = Object.values(userStats);
      
      if (currentView === 'quantity') {
        userArray.sort((a, b) => b.totalQuantity - a.totalQuantity);
      } else if (currentView === 'value') {
        userArray.sort((a, b) => b.totalValue - a.totalValue);
      } else {
        userArray.sort((a, b) => b.totalPoints - a.totalPoints);
      }
      
      // Update leaderboard table
      displayLeaderboard(userArray);
      
      // Update top donor info
      updateTopDonorInfo(userArray);
    }

    // Parse total value from string or number
    function parseTotalValue(value) {
      if (typeof value === 'string') {
        return parseFloat(value.replace('RM ', '').replace(',', '')) || 0;
      }
      return parseFloat(value) || 0;
    }

    // Display leaderboard in table - FIXED: Removed points breakdown display
    function displayLeaderboard(users) {
      leaderboardBody.innerHTML = '';
      
      if (users.length === 0) {
        leaderboardBody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: #666;">No donations found for the selected filters.</td></tr>`;
        return;
      }
      
      users.forEach((user, index) => {
        const rank = index + 1;
        const row = document.createElement('tr');
        
        // Add special classes for top 3
        if (rank === 1) row.classList.add('top-1');
        if (rank === 2) row.classList.add('top-2');
        if (rank === 3) row.classList.add('top-3');
        
        // Create user avatar from initials
        const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        
        // Show phone number only if user is admin
        const phoneDisplay = currentUserRole === 'admin' ? user.phone : '***';
        
        // Determine which badge to show based on current view
        let rankBadge = '';
        if (rank === 1) {
          rankBadge = '<span class="badge badge-gold">Top Donor</span>';
        } else if (rank === 2) {
          rankBadge = '<span class="badge badge-silver">2nd</span>';
        } else if (rank === 3) {
          rankBadge = '<span class="badge badge-bronze">3rd</span>';
        }
        
        // Points breakdown tooltip - FIXED: Removed donation quantity points
        const uniqueEventsCount = user.events.size;
        const pointsBreakdown = `
Points Breakdown:
- User Profile: ${user.userProfilePoints} pts (signup, quiz, donations, etc.)
- Event Participation: ${user.eventParticipationPoints} pts (${uniqueEventsCount} events)
= TOTAL: ${user.totalPoints} points
        `.trim();
        
        row.innerHTML = `
          <td class="rank-cell">
            ${rank <= 3 ? '' : rank}
            ${rank === 1 ? '<i class="fas fa-crown"></i>' : ''}
          </td>
          <td>
            <div class="user-cell">
              <div class="user-avatar">${initials}</div>
              <div>
                <div class="user-name">${user.name}</div>
                <div class="contact-info">${phoneDisplay}</div>
              </div>
            </div>
          </td>
          <td class="quantity-cell">
            ${user.totalQuantity.toFixed(2)} kg
            ${currentView === 'quantity' ? rankBadge : ''}
          </td>
          <td class="value-cell">RM ${user.totalValue.toFixed(2)}</td>
          <td class="points-cell" title="${pointsBreakdown}">
            <strong>${user.totalPoints} pts</strong>
            ${currentView === 'points' ? rankBadge : ''}
          </td>
          <td>${uniqueEventsCount} <span class="badge badge-green">Events</span></td>
        `;
        
        leaderboardBody.appendChild(row);
      });
    }

    // Update top donor information
    function updateTopDonorInfo(users) {
      if (users.length > 0) {
        const topDonor = users[0];
        topDonorName.textContent = topDonor.name;
        
        if (currentView === 'quantity') {
          topDonorAmount.textContent = `${topDonor.totalQuantity.toFixed(2)} kg`;
        } else if (currentView === 'value') {
          topDonorAmount.textContent = `RM ${topDonor.totalValue.toFixed(2)}`;
        } else {
          topDonorAmount.textContent = `${topDonor.totalPoints} points`;
        }
      } else {
        topDonorName.textContent = '-';
        topDonorAmount.textContent = '-';
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Add any initialization code here if needed
    });
  </script>
</body>
</html>